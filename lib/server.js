"use strict";var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};require("babel-polyfill");var _restify=require("restify");var _restify2=_interopRequireDefault(_restify);var _mongoose=require("mongoose");var _mongoose2=_interopRequireDefault(_mongoose);var _restifyCookies=require("restify-cookies");var _restifyCookies2=_interopRequireDefault(_restifyCookies);var _dotenv=require("dotenv");var _dotenv2=_interopRequireDefault(_dotenv);var _fs=require("fs");var _fs2=_interopRequireDefault(_fs);var _path=require("path");var _models=require("@frontender-magazine/models");var _ejs=require("ejs");var _ejs2=_interopRequireDefault(_ejs);var _queryString=require("query-string");var _queryString2=_interopRequireDefault(_queryString);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{return Promise.resolve(value).then(function(value){step("next",value)},function(err){step("throw",err)})}}return step("next")})}}if(!global.Intl){global.Intl=require("intl");// eslint-disable-line
}var IntlRelativeFormat=require("intl-relativeformat");var rf=new IntlRelativeFormat("ru");var articlesTemplate=_fs2.default.readFileSync((0,_path.resolve)(__dirname,"../source/components/Articles/Articles.ejs"),{encoding:"utf-8"});var ENV_PATH=(0,_path.resolve)(__dirname,"../../.env");var CONFIG_DIR="../config/";var CONFIG_PATH=(0,_path.resolve)(__dirname,CONFIG_DIR+"application."+(process.env.NODE_ENV||"local")+".json");if(!_fs2.default.existsSync(ENV_PATH))throw new Error("Envirnment files not found");_dotenv2.default.config({path:ENV_PATH});if(!_fs2.default.existsSync(CONFIG_PATH))throw new Error("Config not found: "+CONFIG_PATH);var config=require(CONFIG_PATH);// eslint-disable-line
var _require=require("../package.json"),name=_require.name,version=_require.version;var PORT=process.env.PORT||4000;var server=_restify2.default.createServer({name:name,version:version,formatters:{"application/json":function applicationJson(req,res,body){return JSON.stringify(body)},"text/html":function textHtml(req,res,body){return body}}});server.pre(_restify2.default.plugins.pre.dedupeSlashes());server.pre(_restify2.default.plugins.pre.sanitizePath());server.use(_restify2.default.plugins.acceptParser(server.acceptable));server.use(_restify2.default.plugins.queryParser());server.use(_restify2.default.plugins.bodyParser());server.use(_restify2.default.plugins.gzipResponse());server.use(_restifyCookies2.default.parse);server.pre(function(req,res,next){res.charSet("utf-8");return next()});server.get({path:/\/(styles|images)\/*/,name:"Serve styles"},_restify2.default.plugins.serveStatic({directory:__dirname+"/../build/"}));/**
 * Show articles list
 * @return {string} - html of the page
 */server.get({path:"/",name:"Show articles list"},function(){var _ref=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function _callee(req,res,next){var params,query,result,page,perPage,full,total,pagesCount,links,articles,rendered;return regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(req.query.s!==undefined&&req.query.s.trim().length===0){delete req.query.s}params=_extends({},req.query);delete params.page;params=_queryString2.default.stringify(params);query=[];query.push({$match:{state:"published"}});_context.next=8;return _models.Event.aggregate(query);case 8:result=_context.sent;result=result.map(function(event){return event.article_id});query=[];if(req.query.s!==undefined){res.setHeader("Cache-Control","no-cache");query.push({$match:{$and:[{$text:{$search:req.query.s,$caseSensitive:false,$diacriticSensitive:false}},{_id:{$in:result}}]}})}else{query.push({$match:{_id:{$in:result}}})}query.push({$unwind:{path:"$translations",preserveNullAndEmptyArrays:true}});query.push({$lookup:{from:"users",localField:"author",foreignField:"_id",as:"author"}});query.push({$lookup:{from:"users",localField:"translations.author",foreignField:"_id",as:"translations.author"}});query.push({$group:{_id:"$_id",url:{$first:"$url"},domain:{$first:"$domain"},title:{$first:"$title"},published:{$first:"$published"},lang:{$first:"$lang"},tags:{$first:"$tags"},contributors:{$first:"$contributors"},author:{$first:"$author"},translations:{$push:"$translations"}}});query.push({$sort:{published:-1}});page=parseInt(req.query.page,10)||1;perPage=parseInt(req.query.per_page,10)||10;_context.next=21;return _models.Article.aggregate(query);case 21:full=_context.sent;total=full.length;pagesCount=Math.ceil(total/perPage);page=Math.min(page,pagesCount);links=[];links.push("<"+config.domain+"?page=1>; rel=first");if(page>1){links.push("<"+config.domain+"?page="+(page-1)+">; rel=prev")}links.push("<"+config.domain+"?page="+page+">; rel=self");if(page<pagesCount){links.push("<"+config.domain+"?page="+(page+1)+">; rel=prev")}links.push("<"+config.domain+"?page="+pagesCount+">; rel=last");res.setHeader("Link",links.join(", "));_context.next=34;return _models.Article.aggregate(query).skip(Math.max(page-1,0)*perPage).limit(perPage);case 34:articles=_context.sent;articles=articles.map(function(article){var publishedHuman=rf.format(new Date(article.published));var isTranslation=article.domain!=="frontender.info";var data={isTranslation:isTranslation,url:article.url,title:article.title,published:article.published,publishedHuman:publishedHuman,author:article.author};if(isTranslation){var translations=article.translations.filter(function(translation){return translation.domain==="frontender.info"});var translation=translations.length>0?translations[0]:null;var translatedHuman=rf.format(new Date(translation.published));data=_extends({},data,{isTranslation:isTranslation,url:translation.url,title:translation.title,translated:translation.published,translatedHuman:translatedHuman,translator:translation!==null?translation.author:[]})}return data});rendered=_ejs2.default.render(articlesTemplate,{params:params,keywords:req.query.s!==undefined?req.query.s:"",articles:articles,pagesCount:pagesCount,page:page,articlePaginationTemplate:(0,_path.resolve)(__dirname,"../source/components/Pagination/Pagination.ejs"),articleFormTemplate:(0,_path.resolve)(__dirname,"../source/components/SearchForm/SearchForm.ejs"),articleCardTemplate:(0,_path.resolve)(__dirname,"../source/components/ArticleCard/ArticleCard.ejs")});res.setHeader("Content-Type","text/html; charset=utf-8");res.setHeader("Content-Length",Buffer.byteLength(rendered));res.setHeader("X-Pagination-Current-Page",page);res.setHeader("X-Pagination-Per-Page",perPage);res.setHeader("X-Pagination-Total-Count",total);res.setHeader("X-Pagination-Page-Count",pagesCount);res.status(200);res.send(rendered);res.end();return _context.abrupt("return",next());case 47:case"end":return _context.stop();}}},_callee,undefined)}));return function(_x,_x2,_x3){return _ref.apply(this,arguments)}}());_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function _callee2(){return regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;_mongoose2.default.Promise=global.Promise;_context2.next=4;return _mongoose2.default.connect("mongodb://"+config.mongoDBHost+":"+config.mongoDBPort+"/"+config.mongoDBName,{useMongoClient:true});case 4:server.listen(PORT);_context2.next=10;break;case 7:_context2.prev=7;_context2.t0=_context2["catch"](0);console.log(_context2.t0);// eslint-disable-line
case 10:case"end":return _context2.stop();}}},_callee2,undefined,[[0,7]])}))();
//# sourceMappingURL=server.js.map