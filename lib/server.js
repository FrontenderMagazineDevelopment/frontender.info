"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _objectSpread2=_interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _restify=_interopRequireDefault(require("restify"));var _mongoose=_interopRequireDefault(require("mongoose"));var _restifyCookies=_interopRequireDefault(require("restify-cookies"));var _dotenv=_interopRequireDefault(require("dotenv"));var _fs=_interopRequireDefault(require("fs"));var _path=require("path");var _models=require("@frontender-magazine/models");var _ejs=_interopRequireDefault(require("ejs"));var _queryString=_interopRequireDefault(require("query-string"));if(!global.Intl){global.Intl=require("intl");// eslint-disable-line
}var IntlRelativeFormat=require("intl-relativeformat");var rf=new IntlRelativeFormat("ru");var articlesTemplate=_fs.default.readFileSync((0,_path.resolve)(__dirname,"../source/components/Articles/Articles.ejs"),{encoding:"utf-8"});var ENV_PATH=(0,_path.resolve)(__dirname,"../.env");_dotenv.default.config({allowEmptyValues:false,path:ENV_PATH});var _process$env=process.env,MONGODB_PORT=_process$env.MONGODB_PORT,MONGODB_HOST=_process$env.MONGODB_HOST,MONGODB_NAME=_process$env.MONGODB_NAME,DOMAIN=_process$env.DOMAIN;var _require=require("../package.json"),name=_require.name,version=_require.version;var PORT=process.env.PORT||4000;var server=_restify.default.createServer({name:name,version:version,formatters:{"application/json":function applicationJson(req,res,body){return JSON.stringify(body)},"text/html":function textHtml(req,res,body){return body}}});server.pre(_restify.default.plugins.pre.dedupeSlashes());server.pre(_restify.default.plugins.pre.sanitizePath());server.use(_restify.default.plugins.acceptParser(server.acceptable));server.use(_restify.default.plugins.queryParser());server.use(_restify.default.plugins.bodyParser());server.use(_restify.default.plugins.gzipResponse());server.use(_restifyCookies.default.parse);server.pre(function(req,res,next){res.charSet("utf-8");return next()});server.get({path:/\/(styles|images)\/*/,name:"Serve styles"},_restify.default.plugins.serveStatic({directory:"".concat(__dirname,"/../build/")}));/**
 * Show articles list
 * @return {string} - html of the page
 */server.get({path:"/",name:"Show articles list"},/*#__PURE__*/function(){var _ref=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function _callee(req,res,next){var params,query,result,page,perPage,full,total,pagesCount,links,articles,rendered;return _regenerator.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(req.query.s!==undefined&&req.query.s.trim().length===0){delete req.query.s}params=(0,_objectSpread2.default)({},req.query);delete params.page;params=_queryString.default.stringify(params);query=[];query.push({$match:{state:"published"}});_context.next=8;return _models.Event.aggregate(query);case 8:result=_context.sent;result=result.map(function(event){return event.article_id});query=[];if(req.query.s!==undefined){res.setHeader("Cache-Control","no-cache");query.push({$match:{$and:[{$text:{$search:req.query.s,$caseSensitive:false,$diacriticSensitive:false}},{_id:{$in:result}}]}})}else{query.push({$match:{_id:{$in:result}}})}query.push({$unwind:{path:"$translations",preserveNullAndEmptyArrays:true}});query.push({$lookup:{from:"users",localField:"author",foreignField:"_id",as:"author"}});query.push({$lookup:{from:"users",localField:"translations.author",foreignField:"_id",as:"translations.author"}});query.push({$group:{_id:"$_id",url:{$first:"$url"},domain:{$first:"$domain"},title:{$first:"$title"},published:{$first:"$published"},lang:{$first:"$lang"},tags:{$first:"$tags"},contributors:{$first:"$contributors"},author:{$first:"$author"},translations:{$push:"$translations"}}});query.push({$sort:{published:-1}});page=parseInt(req.query.page,10)||1;perPage=parseInt(req.query.per_page,10)||10;_context.next=21;return _models.Article.aggregate(query);case 21:full=_context.sent;total=full.length;pagesCount=Math.ceil(total/perPage);page=Math.min(page,pagesCount);links=[];links.push("<".concat(DOMAIN,"?page=1>; rel=first"));if(page>1){links.push("<".concat(DOMAIN,"?page=").concat(page-1,">; rel=prev"))}links.push("<".concat(DOMAIN,"?page=").concat(page,">; rel=self"));if(page<pagesCount){links.push("<".concat(DOMAIN,"?page=").concat(page+1,">; rel=prev"))}links.push("<".concat(DOMAIN,"?page=").concat(pagesCount,">; rel=last"));res.setHeader("Link",links.join(", "));_context.next=34;return _models.Article.aggregate(query).skip(Math.max(page-1,0)*perPage).limit(perPage);case 34:articles=_context.sent;articles=articles.map(function(article){var publishedHuman=rf.format(new Date(article.published));var isTranslation=article.domain!=="frontender.info";var data={isTranslation:isTranslation,url:article.url,title:article.title,published:article.published,publishedHuman:publishedHuman,author:article.author};if(isTranslation){var translations=article.translations.filter(function(translation){return translation.domain==="frontender.info"});var translation=translations.length>0?translations[0]:null;var translatedHuman=rf.format(new Date(translation.published));data=(0,_objectSpread2.default)({},data,{isTranslation:isTranslation,url:translation.url,title:translation.title,translated:translation.published,translatedHuman:translatedHuman,translator:translation!==null?translation.author:[]})}return data});rendered=_ejs.default.render(articlesTemplate,{params:params,keywords:req.query.s!==undefined?req.query.s:"",articles:articles,pagesCount:pagesCount,page:page,articlePaginationTemplate:(0,_path.resolve)(__dirname,"../source/components/Pagination/Pagination.ejs"),articleFormTemplate:(0,_path.resolve)(__dirname,"../source/components/SearchForm/SearchForm.ejs"),articleCardTemplate:(0,_path.resolve)(__dirname,"../source/components/ArticleCard/ArticleCard.ejs")});res.setHeader("Content-Type","text/html; charset=utf-8");res.setHeader("Content-Length",Buffer.byteLength(rendered));res.setHeader("X-Pagination-Current-Page",page);res.setHeader("X-Pagination-Per-Page",perPage);res.setHeader("X-Pagination-Total-Count",total);res.setHeader("X-Pagination-Page-Count",pagesCount);res.status(200);res.send(rendered);res.end();return _context.abrupt("return",next());case 47:case"end":return _context.stop();}}},_callee)}));return function(_x,_x2,_x3){return _ref.apply(this,arguments)}}());(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function _callee2(){return _regenerator.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_mongoose.default.Promise=global.Promise;_context2.next=3;return _mongoose.default.connect("mongodb://".concat(MONGODB_HOST,":").concat(MONGODB_PORT,"/").concat(MONGODB_NAME),{useNewUrlParser:true,useCreateIndex:true});case 3:server.listen(PORT);case 4:case"end":return _context2.stop();}}},_callee2)}))();
//# sourceMappingURL=server.js.map