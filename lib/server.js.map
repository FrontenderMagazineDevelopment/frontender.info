{"version":3,"sources":["../source/server.js"],"names":["global","Intl","require","IntlRelativeFormat","rf","articlesTemplate","readFileSync","__dirname","encoding","ENV_PATH","CONFIG_DIR","CONFIG_PATH","process","env","NODE_ENV","existsSync","Error","config","path","name","version","PORT","server","createServer","formatters","req","res","body","JSON","stringify","pre","plugins","dedupeSlashes","sanitizePath","use","acceptParser","acceptable","queryParser","bodyParser","gzipResponse","parse","next","charSet","get","serveStatic","directory","query","s","undefined","trim","length","params","page","push","$match","state","aggregate","result","map","event","article_id","setHeader","$and","$text","$search","$caseSensitive","$diacriticSensitive","_id","$in","$unwind","preserveNullAndEmptyArrays","$lookup","from","localField","foreignField","as","$group","url","$first","domain","title","published","lang","tags","contributors","author","translations","$push","$sort","parseInt","perPage","per_page","full","total","pagesCount","Math","ceil","min","links","join","skip","max","limit","articles","publishedHuman","format","Date","article","isTranslation","data","filter","translation","translatedHuman","translated","translator","rendered","render","keywords","articlePaginationTemplate","articleFormTemplate","articleCardTemplate","Buffer","byteLength","status","send","end","Promise","connect","mongoDBHost","mongoDBPort","mongoDBName","useMongoClient","listen","console","log"],"mappings":"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","file":"server.js","sourcesContent":["import \"babel-polyfill\";\nimport restify from \"restify\";\nimport mongoose from \"mongoose\";\nimport cookieParser from \"restify-cookies\";\nimport dotenv from \"dotenv\";\nimport fs from \"fs\";\nimport { resolve } from \"path\";\nimport { Article, Event } from \"@frontender-magazine/models\";\nimport ejs from \"ejs\";\nimport queryString from \"query-string\";\n\nif (!global.Intl) {\n  global.Intl = require(\"intl\"); // eslint-disable-line\n}\nconst IntlRelativeFormat = require(\"intl-relativeformat\");\n\nconst rf = new IntlRelativeFormat(\"ru\");\n\nconst articlesTemplate = fs.readFileSync(\n  resolve(__dirname, \"../source/components/Articles/Articles.ejs\"),\n  {\n    encoding: \"utf-8\"\n  }\n);\n\nconst ENV_PATH = resolve(__dirname, \"../../.env\");\nconst CONFIG_DIR = \"../config/\";\nconst CONFIG_PATH = resolve(\n  __dirname,\n  `${CONFIG_DIR}application.${process.env.NODE_ENV || \"local\"}.json`\n);\nif (!fs.existsSync(ENV_PATH)) throw new Error(\"Envirnment files not found\");\ndotenv.config({ path: ENV_PATH });\n\nif (!fs.existsSync(CONFIG_PATH))\n  throw new Error(`Config not found: ${CONFIG_PATH}`);\nconst config = require(CONFIG_PATH); // eslint-disable-line\nconst { name, version } = require(\"../package.json\");\n\nconst PORT = process.env.PORT || 4000;\nconst server = restify.createServer({\n  name,\n  version,\n  formatters: {\n    \"application/json\": function(req, res, body) {\n      return JSON.stringify(body);\n    },\n    \"text/html\": function(req, res, body) {\n      return body;\n    }\n  }\n});\n\nserver.pre(restify.plugins.pre.dedupeSlashes());\nserver.pre(restify.plugins.pre.sanitizePath());\nserver.use(restify.plugins.acceptParser(server.acceptable));\nserver.use(restify.plugins.queryParser());\nserver.use(restify.plugins.bodyParser());\nserver.use(restify.plugins.gzipResponse());\nserver.use(cookieParser.parse);\n\nserver.pre((req, res, next) => {\n  res.charSet(\"utf-8\");\n  return next();\n});\n\nserver.get(\n  {\n    path: /\\/(styles|images)\\/*/,\n    name: \"Serve styles\"\n  },\n  restify.plugins.serveStatic({\n    directory: `${__dirname}/../build/`\n  })\n);\n\n/**\n * Show articles list\n * @return {string} - html of the page\n */\nserver.get(\n  {\n    path: \"/\",\n    name: \"Show articles list\"\n  },\n  async (req, res, next) => {\n    if (req.query.s !== undefined && req.query.s.trim().length === 0) {\n      delete req.query.s;\n    }\n\n    let params = {\n      ...req.query\n    };\n    delete params.page;\n    params = queryString.stringify(params);\n\n    let query = [];\n\n    query.push({\n      $match: {\n        state: \"published\"\n      }\n    });\n\n    let result = await Event.aggregate(query);\n    result = result.map(event => event.article_id);\n\n    query = [];\n\n    if (req.query.s !== undefined) {\n      res.setHeader(\"Cache-Control\", \"no-cache\");\n      query.push({\n        $match: {\n          $and: [\n            {\n              $text: {\n                $search: req.query.s,\n                $caseSensitive: false,\n                $diacriticSensitive: false\n              }\n            },\n            {\n              _id: { $in: result }\n            }\n          ]\n        }\n      });\n    } else {\n      query.push({ $match: { _id: { $in: result } } });\n    }\n\n    query.push({\n      $unwind: {\n        path: \"$translations\",\n        preserveNullAndEmptyArrays: true\n      }\n    });\n\n    query.push({\n      $lookup: {\n        from: \"users\",\n        localField: \"author\",\n        foreignField: \"_id\",\n        as: \"author\"\n      }\n    });\n\n    query.push({\n      $lookup: {\n        from: \"users\",\n        localField: \"translations.author\",\n        foreignField: \"_id\",\n        as: \"translations.author\"\n      }\n    });\n\n    query.push({\n      $group: {\n        _id: \"$_id\",\n        url: { $first: \"$url\" },\n        domain: { $first: \"$domain\" },\n        title: { $first: \"$title\" },\n        published: { $first: \"$published\" },\n        lang: { $first: \"$lang\" },\n        tags: { $first: \"$tags\" },\n        contributors: { $first: \"$contributors\" },\n        author: { $first: \"$author\" },\n        translations: { $push: \"$translations\" }\n      }\n    });\n\n    query.push({\n      $sort: {\n        published: -1\n      }\n    });\n\n    let page = parseInt(req.query.page, 10) || 1;\n    const perPage = parseInt(req.query.per_page, 10) || 10;\n    const full = await Article.aggregate(query);\n    const total = full.length;\n    const pagesCount = Math.ceil(total / perPage);\n\n    page = Math.min(page, pagesCount);\n\n    const links = [];\n    links.push(`<${config.domain}?page=1>; rel=first`);\n    if (page > 1) {\n      links.push(`<${config.domain}?page=${page - 1}>; rel=prev`);\n    }\n    links.push(`<${config.domain}?page=${page}>; rel=self`);\n    if (page < pagesCount) {\n      links.push(`<${config.domain}?page=${page + 1}>; rel=prev`);\n    }\n    links.push(`<${config.domain}?page=${pagesCount}>; rel=last`);\n    res.setHeader(\"Link\", links.join(\", \"));\n\n    let articles = await Article.aggregate(query)\n      .skip(Math.max(page - 1, 0) * perPage)\n      .limit(perPage);\n    articles = articles.map(article => {\n      const publishedHuman = rf.format(new Date(article.published));\n      const isTranslation = article.domain !== \"frontender.info\";\n      let data = {\n        isTranslation,\n        url: article.url,\n        title: article.title,\n        published: article.published,\n        publishedHuman,\n        author: article.author\n      };\n\n      if (isTranslation) {\n        const translations = article.translations.filter(\n          translation => translation.domain === \"frontender.info\"\n        );\n        const translation = translations.length > 0 ? translations[0] : null;\n        const translatedHuman = rf.format(new Date(translation.published));\n\n        data = {\n          ...data,\n          isTranslation,\n          url: translation.url,\n          title: translation.title,\n          translated: translation.published,\n          translatedHuman,\n          translator: translation !== null ? translation.author : []\n        };\n      }\n\n      return data;\n    });\n\n    const rendered = ejs.render(articlesTemplate, {\n      params,\n      keywords: req.query.s !== undefined ? req.query.s : \"\",\n      articles,\n      pagesCount,\n      page,\n      articlePaginationTemplate: resolve(\n        __dirname,\n        \"../source/components/Pagination/Pagination.ejs\"\n      ),\n      articleFormTemplate: resolve(\n        __dirname,\n        \"../source/components/SearchForm/SearchForm.ejs\"\n      ),\n      articleCardTemplate: resolve(\n        __dirname,\n        \"../source/components/ArticleCard/ArticleCard.ejs\"\n      )\n    });\n\n    res.setHeader(\"Content-Type\", \"text/html; charset=utf-8\");\n    res.setHeader(\"Content-Length\", Buffer.byteLength(rendered));\n    res.setHeader(\"X-Pagination-Current-Page\", page);\n    res.setHeader(\"X-Pagination-Per-Page\", perPage);\n    res.setHeader(\"X-Pagination-Total-Count\", total);\n    res.setHeader(\"X-Pagination-Page-Count\", pagesCount);\n\n    res.status(200);\n    res.send(rendered);\n    res.end();\n    return next();\n  }\n);\n\n(async () => {\n  try {\n    mongoose.Promise = global.Promise;\n    await mongoose.connect(\n      `mongodb://${config.mongoDBHost}:${config.mongoDBPort}/${\n        config.mongoDBName\n      }`,\n      { useMongoClient: true }\n    );\n    server.listen(PORT);\n  } catch (error) {\n    console.log(error); // eslint-disable-line\n  }\n})();\n"]}